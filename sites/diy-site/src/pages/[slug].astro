---
import Layout from '../../../../packages/shared/Layout.astro';
import { fetchDiyPosts } from '../../../../packages/shared/strapi.js';
import { marked } from 'marked';

export async function getStaticPaths() {
  const strapiPosts = await fetchDiyPosts();

  // Create slug from title if slug is not available
  const createSlug = (title) => {
    return title
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/^-|-$/g, '');
  };

  // Only include Strapi posts that have content
  return strapiPosts
    .filter(post => post.content)
    .map(post => {
      const postSlug = post.slug || createSlug(post.title);
      return {
        params: { slug: postSlug },
        props: { post },
      };
    });
}

const { post } = Astro.props;
const title = post.title;
const date = new Date(post.date);

// Render markdown content to HTML
const contentHtml = post.content ? await marked(post.content) : '';

const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
};
---

<Layout
  title={title}
  description={`DIY tutorial: ${title} by Katie Langerman`}
  siteType="diy"
  isDiySite={true}
>
  <main>
    <article class="diy-post">
      <div class="post-header">
        <h1>{title}</h1>
        <!-- <time datetime={date.toISOString()}>
          {formatDate(date)}
        </time> -->
      </div>

      <div class="post-content">
        <div set:html={contentHtml} />
      </div>
    </article>
  </main>
</Layout>
