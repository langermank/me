---
import Layout from '../../../../packages/shared/Layout.astro';
import PostCard from '../../../../packages/shared/PostCard.astro';
import Label from '../../../../packages/shared/Label.astro';
import { getPostTypeById } from '../../../../packages/shared/postTypes';
import { fetchCaseStudies } from '../../../../packages/shared/strapi.js';

const posts = await fetchCaseStudies();
const sortedPosts = posts.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

// Get unique types present in Strapi content and their display labels
const uniqueTypeIds = [...new Set(sortedPosts.map((post) => {
  const typeValue = typeof post.type === 'string' ? post.type : post.type?.name || post.type?.displayName;
  return typeValue;
}).filter(Boolean))];
const availableTypes = uniqueTypeIds
  .map((id) => getPostTypeById(id))
  .filter(Boolean)
  .sort((a, b) => a.label.localeCompare(b.label));
---

<Layout title="Katie Langerman" siteType="main">
  <main>
    <section class="intro">
      <p>I'm a Staff Systems designer at GitHub, shipping code and nudging pixels for the <a href="https://primer.style/">Primer design system.</a></p>
      <p>I enjoy flexing into different domains. If there's something that needs doing, I'll do it.</p>
      <p>
        I co-host an interface design podcast called <a href="https://creators.spotify.com/pod/show/complementary">Complementary</a>, and off screen I'm teaching myself interior design and slowly renovating my house.
      </p>
    </section>

    <section class="work">
      <div class="filter-label-list">
        <ol class="label-list">
          <!-- <li>Filter by:</li> -->
          <li>
            <Label type="all" href="#" />
          </li>
          {availableTypes.map((type) => (
            <li>
              <Label type={type.id} href="#" />
            </li>
          ))}
        </ol>
      </div>

      <div class="post-index" id="post-container">
        {sortedPosts.map((post) => (
          <PostCard
            title={post.title}
            date={new Date(post.date)}
            thumbnail={post.thumbnail}
            description={post.description}
            hasMore={post.hasMore}
            slug={post.slug}
            linkPrefix="/work"
            type={post.type}
            externalUrl={post.externalUrl}
            hasDarkImage={post.hasDarkImage}
            darkThumbnail={post.darkThumbnail}
          />
        ))}
      </div>
    </section>
  </main>
</Layout>

<script>
  class PostFilter {
    constructor() {
      this.container = document.getElementById('post-container');
      this.cards = Array.from(document.querySelectorAll('.card[data-type]'));
      this.labelLinks = Array.from(document.querySelectorAll('.label-list a.label'));

      this.init();
    }

    init() {
      if (!this.container) return;

      // Set unique view transition names for each card
      let cardIndex = 0;
      this.cards.forEach((card) => {
        card.style.viewTransitionName = `post-${++cardIndex}`;
      });

      // Label link filters
      this.labelLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const selectedType = link.dataset.type;
          this.handleFilterChange(selectedType, () => {
            this.updateActiveLabel(link);
          });
        });
      });
    }

    handleFilterChange(selectedType, updateUI) {
      // Check if View Transitions API is supported
      if (!document.startViewTransition) {
        updateUI();
        this.filterPosts(selectedType);
        this.updateURL(selectedType);
        return;
      }

      // Use View Transitions API
      document.startViewTransition(() => {
        updateUI();
        this.filterPosts(selectedType);
        this.updateURL(selectedType);
      });
    }

    updateActiveLabel(activeLink) {
      // Remove aria-current from all labels
      this.labelLinks.forEach(link => {
        link.removeAttribute('aria-current');
      });
      // Add aria-current to clicked label
      activeLink.setAttribute('aria-current', 'page');
    }

    filterPosts(selectedType) {
      this.cards.forEach((card) => {
        const cardType = card.getAttribute('data-type');

        // Check if card matches filter
        if (selectedType === 'all' || selectedType === cardType) {
          card.removeAttribute('hidden');
        } else {
          card.setAttribute('hidden', '');
        }
      });
    }

    updateURL(selectedType) {
      const url = new URL(window.location.href);
      if (selectedType === 'all') {
        url.searchParams.delete('type');
      } else {
        url.searchParams.set('type', selectedType);
      }
      window.history.replaceState({}, '', url);
    }
  }

  // Initialize when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    const postFilter = new PostFilter();

    // Handle initial filter from URL
    const urlParams = new URLSearchParams(window.location.search);
    const typeParam = urlParams.get('type') || 'all';

    // Set initial aria-current for label links AND filter the posts
    const activeLabel = document.querySelector(`.label-list a.label[data-type="${typeParam}"]`);
    if (activeLabel) {
      postFilter.updateActiveLabel(activeLabel);
    }

    // Always filter the posts based on the URL parameter (even if activeLabel is null)
    postFilter.filterPosts(typeParam);
  });
</script>
